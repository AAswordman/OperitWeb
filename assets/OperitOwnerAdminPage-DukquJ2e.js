import{r as s,j as a,b as K,e as I,h as g,T as W,d as X,C,B as T,an as B,aT as Q}from"./index-BUC7ar-9.js";import{s as y}from"./index-Bwaw2ub6.js";import{I as c}from"./index-BG7-Innl.js";import{A as V}from"./index-AJnqX13Z.js";import{F as Y}from"./Table-C0sUloEW.js";import{S as q,T as A}from"./index-BWcCT85H.js";import"./EyeOutlined-DeyaywGd.js";import"./addEventListener-CY0sHx15.js";const{Content:Z}=K,{Title:ee,Paragraph:ae,Text:P}=W,f={apiBase:"operit_submission_admin_api_base",ownerToken:"operit_owner_token"},$=n=>{if(!n)return"-";const j=new Date(n);return Number.isNaN(j.getTime())?n:j.toLocaleString()},ce=()=>{const[n,j]=s.useState(()=>localStorage.getItem(f.apiBase)||"https://api.aaswordsman.org"),[i,F]=s.useState(()=>localStorage.getItem(f.ownerToken)||""),[L,U]=s.useState([]),[k,O]=s.useState(!1),[_,w]=s.useState(null),[R,b]=s.useState(!1),[z,N]=s.useState(!1),[o,h]=s.useState({username:"",displayName:"",role:"reviewer",password:""}),[D,v]=s.useState(!1),[J,E]=s.useState(!1),[t,m]=s.useState({username:"",displayName:"",role:"reviewer",password:"",disabled:!1});s.useEffect(()=>{localStorage.setItem(f.apiBase,n)},[n]),s.useEffect(()=>{i.trim()?localStorage.setItem(f.ownerToken,i):localStorage.removeItem(f.ownerToken)},[i]);const p=s.useCallback(async(e,r)=>{const l=await fetch(e,r),d=await l.text();let S=null;try{S=d?JSON.parse(d):null}catch{S=null}return{response:l,data:S}},[]),u=s.useCallback(()=>({"X-Operit-Owner-Token":i.trim()}),[i]),x=s.useCallback(async()=>{if(!i.trim()){w("Owner token required");return}O(!0),w(null);try{const{response:e,data:r}=await p(`${n.replace(/\/+$/,"")}/api/admin/owner/users`,{headers:u()});if(!e.ok){const d=r?.error||e.statusText;throw new Error(d||"request_failed")}const l=r?.items||[];U(l)}catch(e){w(e.message||"request_failed")}finally{O(!1)}},[n,p,u,i]),M=s.useCallback(async()=>{if(!i.trim()){w("Owner token required");return}N(!0);try{const e={username:o.username.trim(),display_name:o.displayName.trim()||void 0,role:o.role,password:o.password},{response:r,data:l}=await p(`${n.replace(/\/+$/,"")}/api/admin/owner/users`,{method:"POST",headers:{...u(),"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r.ok){const d=l?.error||r.statusText;throw new Error(d||"request_failed")}b(!1),h({username:"",displayName:"",role:"reviewer",password:""}),y.success("Admin created"),await x()}catch(e){y.error(e.message||"request_failed")}finally{N(!1)}},[n,o,p,x,u,i]),G=s.useCallback(async()=>{if(!i.trim()){w("Owner token required");return}if(!t.username.trim()){y.error("username required");return}E(!0);try{const e={display_name:t.displayName.trim()||"",role:t.role,disabled:t.disabled};t.password.trim()&&(e.password=t.password);const{response:r,data:l}=await p(`${n.replace(/\/+$/,"")}/api/admin/owner/users/${encodeURIComponent(t.username.trim())}`,{method:"POST",headers:{...u(),"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r.ok){const d=l?.error||r.statusText;throw new Error(d||"request_failed")}v(!1),m({username:"",displayName:"",role:"reviewer",password:"",disabled:!1}),y.success("Admin updated"),await x()}catch(e){y.error(e.message||"request_failed")}finally{E(!1)}},[n,t,p,x,u,i]),H=[{title:"Username",dataIndex:"username",width:180,render:e=>a.jsx(P,{code:!0,children:e})},{title:"Display Name",dataIndex:"display_name",width:220,render:e=>e||"-"},{title:"Role",dataIndex:"role",width:120,render:e=>a.jsx(A,{color:e==="admin"?"red":"blue",children:e})},{title:"Status",dataIndex:"disabled_at",width:140,render:e=>a.jsx(A,{color:e?"default":"green",children:e?"disabled":"active"})},{title:"Created",dataIndex:"created_at",width:180,render:e=>$(e)},{title:"Updated",dataIndex:"updated_at",width:180,render:e=>$(e)},{title:"Actions",dataIndex:"actions",width:120,render:(e,r)=>a.jsx(T,{size:"small",onClick:()=>{m({username:r.username,displayName:r.display_name||"",role:r.role,password:"",disabled:!!r.disabled_at}),v(!0)},children:"Edit"})}];return a.jsx("main",{style:{paddingTop:88,paddingBottom:48},children:a.jsxs(Z,{style:{maxWidth:1200,margin:"0 auto",padding:"0 24px"},children:[a.jsx(I,{children:a.jsxs(g,{direction:"vertical",size:"large",style:{width:"100%"},children:[a.jsxs("div",{children:[a.jsx(ee,{level:2,style:{marginBottom:8},children:"Operit 站长后台"}),a.jsx(ae,{type:"secondary",style:{marginBottom:0},children:"仅站长可访问：管理管理员账号、角色与启用状态。"})]}),a.jsxs(X,{gutter:[16,16],align:"middle",children:[a.jsx(C,{xs:24,lg:12,children:a.jsx(c,{value:n,onChange:e=>j(e.target.value),placeholder:"API Base (https://api.aaswordsman.org)"})}),a.jsx(C,{xs:24,lg:12,children:a.jsx(c.Password,{value:i,onChange:e=>F(e.target.value),placeholder:"Owner token"})}),a.jsx(C,{xs:24,children:a.jsxs(g,{children:[a.jsx(T,{type:"primary",onClick:x,loading:k,children:"Load admins"}),a.jsx(T,{onClick:()=>b(!0),disabled:!i.trim(),children:"New admin"})]})})]})]})}),_&&a.jsx(V,{type:"error",showIcon:!0,style:{marginTop:16},message:"Owner panel error",description:_}),a.jsx(I,{style:{marginTop:16},children:a.jsx(Y,{rowKey:"username",loading:k,columns:H,dataSource:L,pagination:!1,scroll:{x:"max-content"}})}),a.jsx(B,{title:"Create admin",open:R,onCancel:()=>b(!1),onOk:M,confirmLoading:z,children:a.jsxs(g,{direction:"vertical",size:"middle",style:{width:"100%"},children:[a.jsx(c,{value:o.username,onChange:e=>h(r=>({...r,username:e.target.value})),placeholder:"username"}),a.jsx(c,{value:o.displayName,onChange:e=>h(r=>({...r,displayName:e.target.value})),placeholder:"display name"}),a.jsx(q,{value:o.role,options:[{label:"reviewer",value:"reviewer"},{label:"admin",value:"admin"}],onChange:e=>h(r=>({...r,role:e}))}),a.jsx(c.Password,{value:o.password,onChange:e=>h(r=>({...r,password:e.target.value})),placeholder:"password"})]})}),a.jsx(B,{title:`Edit admin: ${t.username||"-"}`,open:D,onCancel:()=>v(!1),onOk:G,confirmLoading:J,children:a.jsxs(g,{direction:"vertical",size:"middle",style:{width:"100%"},children:[a.jsx(c,{disabled:!0,value:t.username,placeholder:"username"}),a.jsx(c,{value:t.displayName,onChange:e=>m(r=>({...r,displayName:e.target.value})),placeholder:"display name"}),a.jsx(q,{value:t.role,options:[{label:"reviewer",value:"reviewer"},{label:"admin",value:"admin"}],onChange:e=>m(r=>({...r,role:e}))}),a.jsx(c.Password,{value:t.password,onChange:e=>m(r=>({...r,password:e.target.value})),placeholder:"new password (optional)"}),a.jsxs(g,{children:[a.jsx(Q,{checked:t.disabled,onChange:e=>m(r=>({...r,disabled:e}))}),a.jsx(P,{children:"Disable account"})]})]})})]})})};export{ce as default};
