import{r as t,j as a,b as re,e as J,h as S,T as te,d as ne,C as P,B as $,an as W,b3 as oe}from"./index-DKUkPjHS.js";import{I as w}from"./index-CcbGcHWf.js";import{A as T}from"./index-D8oAPVil.js";import{F as ie}from"./Table-DPM4d9BG.js";import{S as M,T as G}from"./index-DiD37Hnk.js";import"./EyeOutlined-DyiOWBHb.js";import"./addEventListener-DZODSL6R.js";const{Content:le}=re,{Title:de,Paragraph:ce,Text:B}=te,O={apiBase:"operit_submission_admin_api_base",ownerToken:"operit_owner_token"},ue=/^[a-z0-9][a-z0-9._-]{2,31}$/,K=8,me=(l,s)=>(s?{owner_unauthorized:"站长令牌无效，请检查 Owner token。",owner_token_not_configured:"服务端未配置站长令牌。",username_invalid:"用户名不合法（3-32位，仅小写字母/数字/._-）。",password_too_short:"密码太短（至少 8 位）。",role_invalid:"角色无效，请使用 admin 或 reviewer。",user_exists:"该用户名已存在。",invalid_json:"请求格式错误，请重试。",no_changes:"未检测到修改。",not_found:"目标用户不存在。",d1_binding_missing:"服务端数据库未绑定。"}:{owner_unauthorized:"Invalid owner token.",owner_token_not_configured:"Owner token is not configured on server.",username_invalid:"Invalid username (3-32 chars, lowercase letters/numbers/._-).",password_too_short:"Password is too short (min 8 chars).",role_invalid:"Invalid role, use admin or reviewer.",user_exists:"Username already exists.",invalid_json:"Invalid request payload.",no_changes:"No changes detected.",not_found:"Target user not found.",d1_binding_missing:"Server database is not configured."})[l]||"",z=(l,s,i)=>{const u=s||{},n=typeof u.error=="string"?u.error:"",E=n?me(n,i):"",I=i?`请求失败（HTTP ${l.status}）`:`Request failed (HTTP ${l.status})`,k=E||n||I;if(Array.isArray(u.details)&&u.details.length){const x=u.details.map(C=>String(C||"").trim()).filter(Boolean).join(", ");if(x)return`${k}: ${x}`}return k},X=l=>{if(!l)return"-";const s=new Date(l);return Number.isNaN(s.getTime())?l:s.toLocaleString()},_e=({language:l})=>{const s=l==="zh",[i,u]=t.useState(()=>localStorage.getItem(O.apiBase)||"https://api.aaswordsman.org"),[n,E]=t.useState(()=>localStorage.getItem(O.ownerToken)||""),[I,k]=t.useState([]),[x,C]=t.useState(!1),[q,N]=t.useState(null),[U,h]=t.useState(null),[Q,R]=t.useState(!1),[V,L]=t.useState(!1),[F,m]=t.useState(null),[c,_]=t.useState({username:"",displayName:"",role:"reviewer",password:""}),[Y,A]=t.useState(!1),[Z,D]=t.useState(!1),[H,p]=t.useState(null),[o,g]=t.useState({username:"",displayName:"",role:"reviewer",password:"",disabled:!1});t.useEffect(()=>{localStorage.setItem(O.apiBase,i)},[i]),t.useEffect(()=>{n.trim()?localStorage.setItem(O.ownerToken,n):localStorage.removeItem(O.ownerToken)},[n]);const f=t.useCallback(async(e,r)=>{const d=await fetch(e,r),b=await d.text();let j=null;try{j=b?JSON.parse(b):null}catch{j=null}return{response:d,data:j}},[]),y=t.useCallback(()=>({"X-Operit-Owner-Token":n.trim()}),[n]),v=t.useCallback(async()=>{if(N(null),h(null),!n.trim()){N(s?"请先填写 Owner token。":"Owner token is required.");return}C(!0);try{const{response:e,data:r}=await f(`${i.replace(/\/+$/,"")}/api/admin/owner/users`,{headers:y()});if(!e.ok)throw new Error(z(e,r,s));const d=r?.items||[];k(d)}catch(e){N(e.message||(s?"请求失败":"Request failed"))}finally{C(!1)}},[i,f,s,y,n]),ee=t.useCallback(async()=>{if(m(null),h(null),!n.trim()){m(s?"请先填写 Owner token。":"Owner token is required.");return}const e=c.username.trim().toLowerCase(),r=c.password;if(!ue.test(e)){m(s?"用户名格式不正确（3-32位，仅小写字母/数字/._-）。":"Invalid username format (3-32 chars, lowercase letters/numbers/._-).");return}if(r.length<K){m(s?"密码至少 8 位。":"Password must be at least 8 characters.");return}L(!0);try{const d={username:e,display_name:c.displayName.trim()||void 0,role:c.role,password:r},{response:b,data:j}=await f(`${i.replace(/\/+$/,"")}/api/admin/owner/users`,{method:"POST",headers:{...y(),"Content-Type":"application/json"},body:JSON.stringify(d)});if(!b.ok)throw new Error(z(b,j,s));R(!1),m(null),_({username:"",displayName:"",role:"reviewer",password:""}),h(s?"管理员创建成功。":"Admin created."),await v()}catch(d){m(d.message||(s?"请求失败":"Request failed"))}finally{L(!1)}},[i,c,f,s,v,y,n]),ae=t.useCallback(async()=>{if(p(null),h(null),!n.trim()){p(s?"请先填写 Owner token。":"Owner token is required.");return}if(!o.username.trim()){p(s?"用户名不能为空。":"Username is required.");return}if(o.password.trim()&&o.password.trim().length<K){p(s?"新密码至少 8 位。":"New password must be at least 8 characters.");return}D(!0);try{const e={display_name:o.displayName.trim()||"",role:o.role,disabled:o.disabled};o.password.trim()&&(e.password=o.password);const{response:r,data:d}=await f(`${i.replace(/\/+$/,"")}/api/admin/owner/users/${encodeURIComponent(o.username.trim())}`,{method:"POST",headers:{...y(),"Content-Type":"application/json"},body:JSON.stringify(e)});if(!r.ok)throw new Error(z(r,d,s));A(!1),p(null),g({username:"",displayName:"",role:"reviewer",password:"",disabled:!1}),h(s?"管理员更新成功。":"Admin updated."),await v()}catch(e){p(e.message||(s?"请求失败":"Request failed"))}finally{D(!1)}},[i,o,f,s,v,y,n]),se=[{title:"Username",dataIndex:"username",width:180,render:e=>a.jsx(B,{code:!0,children:e})},{title:"Display Name",dataIndex:"display_name",width:220,render:e=>e||"-"},{title:"Role",dataIndex:"role",width:120,render:e=>a.jsx(G,{color:e==="admin"?"red":"blue",children:e})},{title:"Status",dataIndex:"disabled_at",width:140,render:e=>a.jsx(G,{color:e?"default":"green",children:e?"disabled":"active"})},{title:"Created",dataIndex:"created_at",width:180,render:e=>X(e)},{title:"Updated",dataIndex:"updated_at",width:180,render:e=>X(e)},{title:"Actions",dataIndex:"actions",width:120,render:(e,r)=>a.jsx($,{size:"small",onClick:()=>{p(null),g({username:r.username,displayName:r.display_name||"",role:r.role,password:"",disabled:!!r.disabled_at}),A(!0)},children:"Edit"})}];return a.jsx("main",{style:{paddingTop:88,paddingBottom:48},children:a.jsxs(le,{style:{maxWidth:1200,margin:"0 auto",padding:"0 24px"},children:[a.jsx(J,{children:a.jsxs(S,{direction:"vertical",size:"large",style:{width:"100%"},children:[a.jsxs("div",{children:[a.jsx(de,{level:2,style:{marginBottom:8},children:s?"Operit 站长后台":"Operit Owner Console"}),a.jsx(ce,{type:"secondary",style:{marginBottom:0},children:s?"仅站长可访问：管理管理员账号、角色与启用状态。":"Owner-only panel for managing admin accounts, roles and status."})]}),a.jsxs(ne,{gutter:[16,16],align:"middle",children:[a.jsx(P,{xs:24,lg:12,children:a.jsx(w,{value:i,onChange:e=>u(e.target.value),placeholder:"API Base (https://api.aaswordsman.org)"})}),a.jsx(P,{xs:24,lg:12,children:a.jsx(w.Password,{value:n,onChange:e=>E(e.target.value),placeholder:"Owner token"})}),a.jsx(P,{xs:24,children:a.jsxs(S,{children:[a.jsx($,{type:"primary",onClick:v,loading:x,children:s?"加载管理员列表":"Load admins"}),a.jsx($,{onClick:()=>{m(null),h(null),R(!0)},disabled:!n.trim(),children:s?"新建管理员":"New admin"})]})})]})]})}),q&&a.jsx(T,{type:"error",showIcon:!0,style:{marginTop:16},message:s?"站长面板错误":"Owner panel error",description:q}),U&&a.jsx(T,{type:"success",showIcon:!0,style:{marginTop:16},message:s?"操作成功":"Success",description:U}),a.jsx(J,{style:{marginTop:16},children:a.jsx(ie,{rowKey:"username",loading:x,columns:se,dataSource:I,pagination:!1,scroll:{x:"max-content"}})}),a.jsx(W,{title:s?"创建管理员":"Create admin",open:Q,onCancel:()=>{m(null),R(!1)},onOk:ee,confirmLoading:V,children:a.jsxs(S,{direction:"vertical",size:"middle",style:{width:"100%"},children:[F&&a.jsx(T,{type:"error",showIcon:!0,message:F}),a.jsx(w,{value:c.username,onChange:e=>_(r=>({...r,username:e.target.value})),placeholder:s?"用户名（3-32位，小写字母/数字/._-）":"username (3-32, lowercase letters/numbers/._-)"}),a.jsx(w,{value:c.displayName,onChange:e=>_(r=>({...r,displayName:e.target.value})),placeholder:s?"显示名（可选）":"display name (optional)"}),a.jsx(M,{value:c.role,options:[{label:"reviewer",value:"reviewer"},{label:"admin",value:"admin"}],onChange:e=>_(r=>({...r,role:e}))}),a.jsx(w.Password,{value:c.password,onChange:e=>_(r=>({...r,password:e.target.value})),placeholder:s?"密码（至少8位）":"password (min 8 chars)"}),a.jsx(B,{type:"secondary",children:s?"密码至少 8 位；用户名只能小写字母/数字/._-。":"Password must be at least 8 chars; username allows lowercase letters/numbers/._-."})]})}),a.jsx(W,{title:s?`编辑管理员：${o.username||"-"}`:`Edit admin: ${o.username||"-"}`,open:Y,onCancel:()=>{p(null),A(!1)},onOk:ae,confirmLoading:Z,children:a.jsxs(S,{direction:"vertical",size:"middle",style:{width:"100%"},children:[H&&a.jsx(T,{type:"error",showIcon:!0,message:H}),a.jsx(w,{disabled:!0,value:o.username,placeholder:"username"}),a.jsx(w,{value:o.displayName,onChange:e=>g(r=>({...r,displayName:e.target.value})),placeholder:s?"显示名（可选）":"display name (optional)"}),a.jsx(M,{value:o.role,options:[{label:"reviewer",value:"reviewer"},{label:"admin",value:"admin"}],onChange:e=>g(r=>({...r,role:e}))}),a.jsx(w.Password,{value:o.password,onChange:e=>g(r=>({...r,password:e.target.value})),placeholder:s?"新密码（可选，至少8位）":"new password (optional, min 8 chars)"}),a.jsxs(S,{children:[a.jsx(oe,{checked:o.disabled,onChange:e=>g(r=>({...r,disabled:e}))}),a.jsx(B,{children:s?"禁用账号":"Disable account"})]})]})})]})})};export{_e as default};
