import{u as R,a as V,r as n,j as t,b as K,e as z,h as S,T as N,B as W}from"./index-B-zrKzi5.js";import{T as J}from"./TurnstileWidget-DRSn1IO6.js";import{I as j}from"./index-CN0xdKxZ.js";import{A as T}from"./index-BwlYP6T7.js";import"./EyeOutlined-CtQHaQlo.js";const{Content:$}=K,{Title:q,Paragraph:k}=N,p={adminToken:"operit_submission_admin_token",loginUsername:"operit_submission_admin_login_username"},P="https://api.aaswordsman.org",H=({language:_})=>{const s=_==="zh",b=R(),g=V(),v=n.useMemo(()=>{const a=new URLSearchParams(g.search||"").get("next")||"/operit-submission-admin";return a.startsWith("/")?a:"/operit-submission-admin"},[g.search]),[o,E]=n.useState(()=>localStorage.getItem(p.loginUsername)||""),[d,C]=n.useState(""),[u,m]=n.useState(""),[l,h]=n.useState(""),[I,U]=n.useState(0),[f,i]=n.useState(null),[B,y]=n.useState(!1),L=n.useCallback(e=>{m(e)},[]),O=n.useCallback(()=>{m("")},[]);n.useEffect(()=>{let e=!1;return(async()=>{try{const r=await fetch(`${P}/api/config`);if(!r.ok)return;const c=await r.json();e||h(String(c?.turnstile_site_key||""))}catch{e||h("")}})(),()=>{e=!0}},[]);const x=async()=>{if(!o.trim()||!d.trim()){i(s?"请输入用户名和密码。":"Username and password are required");return}if(!l){i(s?"验证码配置未就绪，请稍后重试。":"Verification config is not ready. Please retry.");return}if(!u){i(s?"请先完成人机验证。":"Please complete verification first.");return}y(!0),i(null);try{const e=await fetch(`${P}/api/admin/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:o.trim(),password:d,turnstile_token:u})}),a=await e.text();let r=null;try{r=a?JSON.parse(a):null}catch{r=null}if(!e.ok){const w=r?.error;throw w==="turnstile_failed"?(m(""),U(A=>A+1),new Error(s?"人机验证失败，请重试。":"Verification failed, please try again.")):new Error(w||e.statusText||"login_failed")}const c=String(r?.token||"");if(!c)throw new Error("token_missing");localStorage.setItem(p.adminToken,c),localStorage.setItem(p.loginUsername,o.trim()),b(v,{replace:!0})}catch(e){i(e.message||(s?"登录失败":"Login failed"))}finally{y(!1)}};return t.jsx("main",{style:{paddingTop:88,paddingBottom:48},children:t.jsx($,{style:{maxWidth:520,margin:"0 auto",padding:"0 24px"},children:t.jsx(z,{children:t.jsxs(S,{direction:"vertical",size:"large",style:{width:"100%"},children:[t.jsxs("div",{children:[t.jsx(q,{level:2,style:{marginBottom:8},children:s?"Operit 登录":"Operit Login"}),t.jsx(k,{type:"secondary",style:{marginBottom:0},children:s?"统一登录入口（后续可扩展普通用户与管理员）。":"Unified sign-in entry (extensible for users and admins)."})]}),t.jsx(j,{value:o,onChange:e=>E(e.target.value),placeholder:s?"用户名":"Username",autoComplete:"username"}),t.jsx(j.Password,{value:d,onChange:e=>C(e.target.value),onPressEnter:x,placeholder:s?"密码":"Password",autoComplete:"current-password"}),l?t.jsxs(S,{direction:"vertical",size:8,style:{width:"100%"},children:[t.jsx(k,{type:"secondary",style:{marginBottom:0},children:s?"请先完成人机验证":"Please complete human verification first"}),t.jsx(J,{siteKey:l,onVerify:L,onExpire:O,theme:"light"},I)]}):t.jsx(T,{type:"warning",showIcon:!0,message:s?"未获取到验证码组件，请稍后刷新。":"Verification widget not available. Please refresh."}),t.jsx(W,{type:"primary",loading:B,onClick:x,disabled:!l||!u,children:s?"登录":"Sign In"}),f&&t.jsx(T,{type:"error",showIcon:!0,message:s?"登录失败":"Sign-in Failed",description:f})]})})})})};export{H as default};
